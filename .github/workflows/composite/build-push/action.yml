name: "Build and push image"
description: "Builds and pushes an image to a registry"

inputs:
  SERVICE:
    description: "Service to build"
    required: true
  IMAGE_NAME:
    description: "Name of image"
    required: true
  REGISTRY_HOST:
    description: "Registry host"
    required: true
  REGISTRY_ENDPOINT:
    description: "Registry endpoint"
    required: true
  REGISTRY_USERNAME:
    description: "Registry username"
    required: true
  REGISTRY_PASSWORD:
    description: "Registry password"
    required: true

runs:
  using: "composite"

  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ inputs.REGISTRY_HOST }}
        username: ${{ inputs.REGISTRY_USERNAME }}
        password: ${{ inputs.REGISTRY_PASSWORD }}

    - name: Set branch name as env variable
      run: |
        currentbranch=$(echo ${GITHUB_REF##*/})
        echo "running on $currentbranch"
        echo "BRANCH=$currentbranch" >> $GITHUB_ENV
      shell: bash

    - name: Compose build ${{ inputs.service }}
      shell: bash
      run: docker-compose build ${{ inputs.service }}
      working-directory: ./src
      env:
        TAG: ${{ env.BRANCH }}
        REGISTRY: ${{ inputs.REGISTRY_ENDPOINT }}

    - name: Compose push ${{ inputs.service }}
      shell: bash
      run: docker-compose push ${{ inputs.service }}
      working-directory: ./src
      env:
        TAG: ${{ env.BRANCH }}
        REGISTRY: ${{ inputs.REGISTRY_ENDPOINT }}
